---

AWSTemplateFormatVersion: 2010-09-09

Mappings:

  test:
    ap-southeast-2:
      AZ1: ap-southeast-2a
      AZ2: ap-southeast-2b
      AZ3: ap-southeast-2c
      BastionHostAmi: ami-0692dea0a2f8a1b35  # Amazon Linux 2 5.10
      BastionHostInstanceType: t3.micro
      BastionHostAsgDesiredCapacity: 1
      BastionHostAsgMaximumSize: 1
      BastionHostAsgMinimumSize: 1
      BastionHostVolumeSize: 20
      BastionHostVolumeType: gp2
      JumpBoxAmi: ami-0692dea0a2f8a1b35  # Amazon Linux 2 5.10
      JumpBoxInstanceType: t3.micro
      JumpBoxAsgDesiredCapacity: 1
      JumpBoxAsgMaximumSize: 1
      JumpBoxAsgMinimumSize: 1
      JumpBoxVolumeSize: 20
      JumpBoxVolumeType: gp2

Parameters:

  Environment:
    Type: String
    Default: test

  NamePrefix:
    Description: A prefix or namespace that can be used for some resources created or accessed by this template.
    Type: String

Resources:

  KeyPair:
    Type: AWS::EC2::KeyPair
    Properties:
      KeyName: !Ref NamePrefix

  ###############
  # BastionHost #
  ###############

  # @see https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ec2-eip.html
  BastionHostEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: BastionHostEIP
        - Key: NamePrefix
          Value: !Ref NamePrefix

  BastionHostSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Bastion Host Security Group
      GroupName: !Sub ${NamePrefix}-BastionHostSecurityGroup
      SecurityGroupEgress: []
      SecurityGroupIngress:
        # TODO: restrict
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: BastionHostSG
        - Key: NamePrefix
          Value: !Ref NamePrefix
      VpcId:
        Fn::ImportValue: !Sub ${NamePrefix}-vpc-id

  BastionHostLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub ${NamePrefix}-BastionHostLaunchTemplate
      LaunchTemplateData:
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: true
            Groups:
              - !Ref BastionHostSecurityGroup
            DeleteOnTermination: true
        BlockDeviceMappings:
          - DeviceName: /dev/xvdf
            Ebs:
              DeleteOnTermination: true
              Encrypted: true
              VolumeSize: !FindInMap [!Ref Environment, !Ref AWS::Region, "BastionHostVolumeSize"]
              VolumeType: !FindInMap [!Ref Environment, !Ref AWS::Region, "BastionHostVolumeType"]
        ImageId: !FindInMap [!Ref Environment, !Ref AWS::Region, "BastionHostAmi"]
        InstanceType: !FindInMap [!Ref Environment, !Ref AWS::Region, "BastionHostInstanceType"]
        KeyName: !Ref KeyPair
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: BastionHost
              - Key: NamePrefix
                Value: !Ref NamePrefix
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: BastionHost
              - Key: NamePrefix
                Value: !Ref NamePrefix
        UserData:
          Fn::Base64: >
            #!/bin/bash -x
            yum update -y
      TagSpecifications:
        -   ResourceType: launch-template
            Tags:
              - Key: Name
                Value: BastionHost
              - Key: NamePrefix
                Value: !Ref NamePrefix

  BastionHostAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub ${NamePrefix}-BastionHostAutoScalingGroup
      AvailabilityZones:
        - Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "AZ1" ]
        - Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "AZ2" ]
        - Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "AZ3" ]
      DesiredCapacity:
        Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "BastionHostAsgDesiredCapacity" ]
      HealthCheckType: EC2
      LaunchTemplate:
        LaunchTemplateId: !Ref BastionHostLaunchTemplate
        Version: !GetAtt BastionHostLaunchTemplate.LatestVersionNumber
      MaxSize:
        Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "BastionHostAsgMaximumSize" ]
      MinSize:
        Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "BastionHostAsgMinimumSize" ]
      Tags:
        - Key: Name
          PropagateAtLaunch: true
          Value: BastionHost
        - Key: NamePrefix
          PropagateAtLaunch: true
          Value: !Ref NamePrefix
      VPCZoneIdentifier:
        - Fn::Select:
          - 0
          - !Split
            - ','
            - Fn::ImportValue: !Sub ${NamePrefix}-public-subnet-list
        - Fn::Select:
          - 1
          - !Split
            - ','
            - Fn::ImportValue: !Sub ${NamePrefix}-public-subnet-list
        - Fn::Select:
          - 2
          - !Split
            - ','
            - Fn::ImportValue: !Sub ${NamePrefix}-public-subnet-list


 ###########
 # JumpBox #
 ###########

  JumpBoxSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: JumpBox Security Group
      GroupName: !Sub ${NamePrefix}-JumpBoxSecurityGroup
      SecurityGroupEgress: []
      SecurityGroupIngress:
        # Public CIDRs
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp:
            Fn::ImportValue: !Sub ${NamePrefix}-public-subnet-cidr
      Tags:
        - Key: Name
          Value: JumpBoxSG
        - Key: NamePrefix
          Value: !Ref NamePrefix
      VpcId:
        Fn::ImportValue: !Sub ${NamePrefix}-vpc-id

  JumpBoxLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub ${NamePrefix}-JumpBoxLaunchTemplate
      LaunchTemplateData:
        NetworkInterfaces:
          - DeviceIndex: 0
            Groups:
              - !Ref JumpBoxSecurityGroup
            DeleteOnTermination: true
        BlockDeviceMappings:
          - DeviceName: /dev/xvdf
            Ebs:
              DeleteOnTermination: true
              Encrypted: true
              VolumeSize: !FindInMap [!Ref Environment, !Ref AWS::Region, "JumpBoxVolumeSize"]
              VolumeType: !FindInMap [!Ref Environment, !Ref AWS::Region, "JumpBoxVolumeType"]
        ImageId: !FindInMap [!Ref Environment, !Ref AWS::Region, "JumpBoxAmi"]
        InstanceType: !FindInMap [!Ref Environment, !Ref AWS::Region, "JumpBoxInstanceType"]
        KeyName: !Ref KeyPair
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: JumpBox
              - Key: NamePrefix
                Value: !Ref NamePrefix
          - ResourceType: volume
            Tags:
              - Key: Name
                Value: JumpBox
              - Key: NamePrefix
                Value: !Ref NamePrefix
        UserData:
          Fn::Base64: >
            #!/bin/bash -x
            yum update -y
      TagSpecifications:
        -   ResourceType: launch-template
            Tags:
              - Key: Name
                Value: JumpBox
              - Key: NamePrefix
                Value: !Ref NamePrefix

  JumpBoxAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub ${NamePrefix}-JumpBoxAutoScalingGroup
      AvailabilityZones:
        - Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "AZ1" ]
        - Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "AZ2" ]
        - Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "AZ3" ]
      DesiredCapacity:
        Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "JumpBoxAsgDesiredCapacity" ]
      HealthCheckType: EC2
      LaunchTemplate:
        LaunchTemplateId: !Ref JumpBoxLaunchTemplate
        Version: !GetAtt JumpBoxLaunchTemplate.LatestVersionNumber
      MaxSize:
        Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "JumpBoxAsgMaximumSize" ]
      MinSize:
        Fn::FindInMap: [ Ref: Environment, Ref: AWS::Region, "JumpBoxAsgMinimumSize" ]
      Tags:
        - Key: Name
          PropagateAtLaunch: true
          Value: JumpBox
        - Key: NamePrefix
          PropagateAtLaunch: true
          Value: !Ref NamePrefix
      VPCZoneIdentifier:
        - Fn::Select:
          - 0
          - !Split
            - ','
            - Fn::ImportValue: !Sub ${NamePrefix}-private-subnet-list
        - Fn::Select:
          - 1
          - !Split
            - ','
            - Fn::ImportValue: !Sub ${NamePrefix}-private-subnet-list
        - Fn::Select:
          - 2
          - !Split
            - ','
            - Fn::ImportValue: !Sub ${NamePrefix}-private-subnet-list
